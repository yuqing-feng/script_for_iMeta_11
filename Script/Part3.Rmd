---
title: "Part3"
author: "Yuqing Feng"
date: "3/29/2023"
output: html_document
---

## Introduction

Ecological deterministic and stochastic processes shape the segment-specific community types.

## Load the packages

```{r}
rm(list = ls())
# CRAN
packages_from_cran = c('dplyr','reshape2','tibble','ggplot2','ggpubr','openxlsx','vegan','patchwork','tidyr','devtools','BiocManager') 
for(p in packages_from_cran){if (!requireNamespace(p)){install.packages(p)}
    library(p, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE)}

# Bioconductor
if (!requireNamespace("DirichletMultinomial", quietly = TRUE))
    BiocManager::install("DirichletMultinomial")
if (!requireNamespace("phyloseq", quietly = TRUE))
    BiocManager::install("phyloseq")

# Github
library(devtools)
if(!requireNamespace("FEAST", quietly = TRUE))
  install_github("cozygene/FEAST")
if(!requireNamespace("EasyAovWlxPlot", quietly = TRUE))
  install_github("taowenmicro/EasyAovWlxPlot")
if(!requireNamespace("pairwiseAdonis", quietly = TRUE))
  install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
```

### Figure 3A DMM clustering of bacterial and fungal communities

```{r}
raw_16S_L6 <- read.csv('../Data/02micro/dmm/level-6_no_archaea.csv')
format_16S_L6 <- raw_16S_L6 %>%
  remove_rownames %>% 
  column_to_rownames(var="index") %>%
  select(-c('Group1','Group2'))%>%
  as.matrix()
raw_ITS_L6 <- read.csv('../Data/02micro/ITS/level-6_for_bar.csv')
format_ITS_L6 <- raw_ITS_L6 %>%
  remove_rownames %>% 
  column_to_rownames(var="X") %>%
  select(-c('Group1','Group2')) %>%
  as.matrix()
set.seed(1234)
fit_16S <- lapply(1:6, dmn, count = format_16S_L6, verbose=TRUE)
lplc_16S <- sapply(fit_16S, laplace) 
best_16S <- fit_16S[[which.min(lplc_16S)]]
cluster_16S <- data.frame(apply(mixture(best_16S), 1, which.max))
colnames(cluster_16S) <- 'Cluster' 
importance_16S <- melt(fitted(best_16S))
cluster_16S$Segment <- rep(c('Cecum','Duodenum','Ileum','Jejunum'),80)
# write.csv(cluster_16S,'../Data/02micro/dmm/cluster_16S.csv')
colnames(importance_16S) <- c('Genus','Cluster','Importance')
# write.csv(importance_16S,'../Data/02micro/dmm/importance_16S.csv')

set.seed(1234)
fit_ITS <- lapply(1:6, dmn, count = format_ITS_L6, verbose=TRUE)
lplc_ITS <- sapply(fit_ITS, laplace)
best_ITS <- fit_ITS[[which.min(lplc_ITS)]]
d_ITS <- melt(fitted(best_ITS))
cluster_ITS <- data.frame(apply(mixture(best_ITS), 1, which.max)) 
colnames(cluster_ITS) <- 'Cluster'
importance_ITS <- melt(fitted(best_ITS))
colnames(importance_ITS) <- c("Genus",'Cluster','Importance')
cluster_ITS$Segment <- rep(c('Cecum','Duodenum','Ileum','Jejunum'),80)
# write.csv(cluster_ITS,'../Data/02micro/dmm/cluster_ITS.csv')
head(importance_16S)
# write.csv(importance_ITS,'../Data/02micro/dmm/importance_ITS.csv')

cluster_16S <- read.csv('../Data/02micro/dmm/cluster_16S.csv',row.names = 1)
cluster_ITS <- read.csv('../Data/02micro/dmm/cluster_ITS.csv',row.names = 1)
cluster_16S$DPH <- rep(c(1,4,7,14,21,28,35,42),each=40)
cluster_ITS$DPH <- rep(c(1,4,7,14,21,28,35,42),each=40)
cluster_16S2 <- melt(table(cluster_16S[,1:3]))
cluster_16S2$Cluster <- as.factor(cluster_16S2$Cluster)
cluster_16S2$Segment <- factor(cluster_16S2$Segment,levels = c('Duodenum','Jejunum','Ileum','Cecum'))
f14_1 <- ggplot(cluster_16S2,aes(x = '', y = value, fill = Cluster)) + 
  geom_bar(stat = 'identity',width = 1) +
  coord_polar('y',start = 0) + 
  facet_grid(Segment~DPH) + 
  scale_fill_manual(values = c('#E64B35','#4DBBD5','#00A087','#3C5488','#F39B7F')) +
  theme_bw() + 
  xlab('Segment') + ylab("DPH") +
  theme(axis.text = element_blank(),axis.ticks = element_blank(),panel.grid  = element_blank(),
        panel.border = element_blank())
cluster_ITS2 <- melt(table(cluster_ITS[,1:3]))
cluster_ITS2$Cluster <- as.factor(cluster_ITS2$Cluster)
cluster_ITS2$Segment <- factor(cluster_ITS2$Segment,levels = c('Duodenum','Jejunum','Ileum','Cecum'))
f14_2 <- ggplot(cluster_ITS2,aes(x = '', y = value, fill = Cluster)) + 
  geom_bar(stat = 'identity',width = 1) +
  coord_polar('y',start = 0) + 
  facet_grid(Segment~DPH) + 
  scale_fill_manual(values = c('#8491B4','#91D1C2','#DC0000','#7E6148')) +
  theme_bw() + 
  xlab('Segment') + ylab("DPH") +
  theme(axis.text = element_blank(),axis.ticks = element_blank(),panel.grid  = element_blank(),
        panel.border = element_blank())
f14_1 / f14_2
```

### Figure S5A,B Taxa that contributed the most to the accuracy of the DMM for each cluster of bacteria and fungi.

```{r}
bac_contri <- read.table('../Data/02micro/dmm/importance_16S.csv',header = T,row.names = 1,sep = ',')
fun_contri <- read.table('../Data/02micro/dmm/importance_ITS.csv',header = T,row.names = 1, sep = ',')

bac1_contri <- bac_contri %>%
  filter(Cluster =='1') %>%
  slice_max(Importance, n = 5)
bac2_contri <- bac_contri %>%
  filter(Cluster =='2') %>%
  slice_max(Importance, n = 5)
bac3_contri <- bac_contri %>%
  filter(Cluster =='3') %>%
  slice_max(Importance, n = 5)
bac4_contri <- bac_contri %>%
  filter(Cluster =='4') %>%
  slice_max(Importance, n = 5)
bac5_contri <- bac_contri %>%
  filter(Cluster =='5') %>%
  slice_max(Importance, n = 5)
bac_all <- rbind(bac1_contri,bac2_contri,bac3_contri,bac4_contri,bac5_contri)
bac_all$Genus[11] <- bac_all$Genus[8] <- 'f__Brocadiaceae'
f14_3 <- ggplot(bac_all,aes(x = Cluster,y = Genus,fill = log2(Importance+1))) +
  geom_tile() +
  scale_fill_continuous(low = '#E64B351F',high = '#E64B35') + 
  theme_bw() + 
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA)) 
fun1_contri <- fun_contri %>%
  filter(Cluster =='1') %>%
  slice_max(Importance, n = 5)
fun2_contri <- fun_contri %>%
  filter(Cluster =='2') %>%
  slice_max(Importance, n = 5)
fun3_contri <- fun_contri %>%
  filter(Cluster =='3') %>%
  slice_max(Importance, n = 5)
fun4_contri <- fun_contri %>%
  filter(Cluster =='4') %>%
  slice_max(Importance, n = 5)

fun_all <- rbind(fun1_contri,fun2_contri,fun3_contri,fun4_contri)
fun_all$Genus[15] <- 'f__Nectriaceae'
f14_4 <- ggplot(fun_all,aes(x = Cluster,y = Genus,fill = log2(Importance+1))) +
  geom_tile() +
  scale_fill_continuous(low = '#4DBBD51F',high = '#4DBBD5') + 
  theme_bw() + 
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA)) 
f14_3 + f14_4
detach("package:DirichletMultinomial", unload = TRUE)
```

### Figure S5 C-H The bacterial and fungal loads in each cluster. The microbial load was measured by the copy number of the marker genes (16S and ITS). The microbial load was measured by the copy number of the marker genes (16S and ITS). Shannon index of the bacterial communities and fungal communities in each cluster. PCoA of Bray-Curtis dissimilarity of absolute abundances of bacterial and fungal taxa.

### Figure 3C The relative contributions of upper microbial communities to the adjacent lower microbial communities.

```{r}
meta1 <- Load_metadata(metadata_path = '../Data/04feast2/meta_jejunum.txt')
meta2 <- Load_metadata(metadata_path = '../Data/04feast2/meta_ileum.txt')
meta3 <- Load_metadata(metadata_path = '../Data/04feast2/meta_cecum.txt')
L6_bac <- Load_CountMatrix(CountMatrix_path = '../Data/04feast2/bacteria.txt')
L6_fun <- Load_CountMatrix(CountMatrix_path = '../Data/04feast2/fungi.txt')

out_bac_DJ <- FEAST(C = L6_bac, 
                    metadata = meta1,
                    different_sources_flag = 1,
                    dir_path = '../Data/material/04feast2/',
                    outfile = './DJ_bac_source_contributions_matrix.txt')
out_bac_JI <- FEAST(C = L6_bac, 
                    metadata = meta2,
                    different_sources_flag = 1,
                    dir_path = '../Data/04feast2/',
                    outfile = './JI_bac_source_contributions_matrix.txt')
out_bac_IC <- FEAST(C = L6_bac, 
                    metadata = meta3,
                    different_sources_flag = 1,
                    dir_path = '../Data/04feast2/',
                    outfile = './IC_bac_source_contributions_matrix.txt')
out_fun_DJ <- FEAST(C = L6_fun, 
                    metadata = meta1,
                    different_sources_flag = 1,
                    dir_path = '../Data/04feast2/',
                    outfile = './DJ_fun_source_contributions_matrix.txt')
out_fun_JI <- FEAST(C = L6_fun, 
                    metadata = meta2,
                    different_sources_flag = 1,
                    dir_path = '../Data/04feast2/',
                    outfile = './JI_fun_source_contributions_matrix.txt')
out_fun_IC <- FEAST(C = L6_fun, 
                    metadata = meta3,
                    different_sources_flag = 1,
                    dir_path = '../Data/04feast2/',
                    outfile = './IC_fun_source_contributions_matrix.txt')
eff_b1 <- c()
eff_b2 <- c()
eff_b3 <- c()
eff_f1 <- c()
eff_f2 <- c()
eff_f3 <- c()

for(i in 1:80){
  eff_b1[i] <- out_bac_DJ[[i]][i]
}
for(i in 1:80){
  eff_b2[i] <- out_bac_JI[[i*2]][i]
}
for(i in 1:80){
  eff_b3[i] <- out_bac_IC[[160+i]][i]
}
for(i in 1:80){
  eff_f1[i] <- out_fun_DJ[[i]][i]
}
for(i in 1:80){
  eff_f2[i] <- out_fun_JI[[i*2]][i]
}
for(i in 1:80){
  eff_f3[i] <- out_fun_IC[[160+i]][i]
}
out_bac_DJ
eff_all <- data.frame('Efficiency' = c(eff_b1,eff_b2,eff_b3,eff_f1,eff_f2,eff_f3),
                      'Segment' = c(rep('DJ',80),rep('JI',80),rep('IC',80),rep('DJ',80),rep('JI',80),rep('IC',80)),
                      'Group' = c(rep('Bacteria',240),rep('Fungi',240)),
                      'DPH' = c(rep(c(1,4,7,14,21,28,35,42),each=10),rep(c(1,4,7,14,21,28,35,42),each=10),
                                rep(c(1,4,7,14,21,28,35,42),each=10),rep(c(1,4,7,14,21,28,35,42),each=10),
                                rep(c(1,4,7,14,21,28,35,42),each=10),rep(c(1,4,7,14,21,28,35,42),each=10)))
eff_all$Segment <- factor(eff_all$Segment, levels = c('DJ','JI','IC'))
f14_11 <- ggplot(eff_all,aes(x = as.factor(DPH),y = Efficiency,fill = Segment)) + 
  geom_boxplot(outlier.shape = NA) +
  theme_bw() + 
  scale_fill_manual(values = c('#E64B35','#4DBBD5','#00A087')) + 
  facet_grid(Group~Segment) + 
  xlab('DPH') + 
  theme(legend.position = 'none')
eff_all %>%
  filter(Group == 'Bacteria') %>%
  select(c(Segment, Efficiency)) %>%
  rownames_to_column() %>%
  rename(group = Segment) %>%
  KwWlx(i = 3)

eff_all %>%
  filter(Group == 'Fungi') %>%
  select(c(Segment, Efficiency)) %>%
  rownames_to_column() %>%
  rename(group = Segment) %>%
  KwWlx(i = 3)

ab_temp <- read.xlsx('../Data/01qpcr/01data_for_quantitive.xlsx',sheet = 2)
rownames(cluster_16S) == ab_temp$ID
clus_16S_ab <- cbind(cluster_16S,ab_temp[,4:5])
clus_ITS_ab <- cbind(cluster_ITS,ab_temp[,4:5])
test1 <- data.frame(rownames(clus_16S_ab),clus_16S_ab$Cluster,clus_16S_ab$`log10(16S)`)
test1           
colnames(test1)[2] <- 'group'
KwWlx(test1,i=3) 
clus_16S_ab$Cluster <- as.factor(clus_16S_ab$Cluster)
f14_5 <- ggplot(clus_16S_ab,aes(x = Cluster, y = `log10(16S)`, fill = Cluster)) + 
  geom_boxplot(outlier.shape = NA) +
  ylab('Number of copy (log10)') +
  xlab('Cluster') +
  theme_bw() +
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA),
        legend.position = 'none') +
  scale_fill_manual(values = c('#E64B35','#4DBBD5','#00A087','#3C5488','#F39B7F')) +
  annotate('text',x = 1,y = 12,label = 'b') +
  annotate('text',x = 2,y = 12,label = 'c') +
  annotate('text',x = 3,y = 12,label = 'a') +
  annotate('text',x = 4,y = 12,label = 'd') + 
  annotate('text',x = 5,y = 12,label = 'cd') +
  ggtitle('Bacteria')
test2 <- data.frame(rownames(clus_ITS_ab),clus_ITS_ab$Cluster,clus_16S_ab$`log10(ITS)`)
test2           
colnames(test2)[2] <- 'group'
KwWlx(test2,i=3) 
clus_ITS_ab$Cluster <- as.factor(clus_ITS_ab$Cluster)
f14_6 <- ggplot(clus_ITS_ab,aes(x = Cluster, y = `log10(ITS)`, fill = Cluster)) + 
  geom_boxplot(outlier.shape = NA) +
  ylab('Number of copy (log10)') +
  xlab('Cluster') +
  theme_bw() +
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA),
        legend.position = 'none') +
  scale_fill_manual(values = c('#8491B4','#91D1C2','#DC0000','#7E6148')) +
  annotate('text',x = 1,y = 12,label = 'a') +
  annotate('text',x = 2,y = 12,label = 'b') +
  annotate('text',x = 3,y = 12,label = 'a') +
  annotate('text',x = 4,y = 12,label = 'b') +
  ggtitle('Fungi')
raw_16S_L6 <- read.csv('../Data/02micro/16S/level-6_no_archaea.csv')
raw_ITS_L6 <- read.csv('../Data/02micro/ITS/level-6_for_bar.csv')

alpha_bacteria <- diversity(raw_16S_L6[,2:530])
alpha_fungi <- diversity(raw_ITS_L6[,2:604])
a_bac <- data.frame('ID'= rownames(cluster_16S),
               'group' = as.factor(cluster_16S$Cluster),
               'Shannon' = alpha_bacteria)
a_fun <- data.frame('ID' = rownames(cluster_ITS),
                    'group' = as.factor(cluster_ITS$Cluster),
                    'Shannon' = alpha_fungi)
KwWlx(a_bac,i=3) 
KwWlx(a_fun,i=3) 
f14_7 <- ggplot(a_bac, aes(x = group,y = Shannon,fill = group)) +
  geom_boxplot(outlier.shape = NA) +
  ylab('Shannon index') +
  xlab('Cluster') +
  theme_bw() +
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA),
        legend.position = 'none') +
  scale_fill_manual(values = c('#E64B35','#4DBBD5','#00A087','#3C5488','#F39B7F')) +
  annotate('text',x = 1,y = 4,label = 'c') +
  annotate('text',x = 2,y = 4,label = 'c') +
  annotate('text',x = 3,y = 4,label = 'a') +
  annotate('text',x = 4,y = 4,label = 'b') + 
  annotate('text',x = 5,y = 4,label = 'b') +
  ggtitle('Bacteria')
f14_8 <- ggplot(a_fun, aes(x = group, y = Shannon, fill = group)) +
  geom_boxplot(outlier.shape = NA) +
  ylab('Shannon index') +
  xlab('Cluster') +
  theme_bw() +
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA),
        legend.position = 'none') +
  scale_fill_manual(values = c('#8491B4','#91D1C2','#DC0000','#7E6148')) +
  annotate('text',x = 1,y = 4.5,label = 'b') +
  annotate('text',x = 2,y = 4.5,label = 'c') +
  annotate('text',x = 3,y = 4.5,label = 'a') +
  annotate('text',x = 4,y = 4.5,label = 'd') +
  ggtitle('Fungi')
format_16S_L6 <- raw_16S_L6 %>%
  remove_rownames %>% 
  column_to_rownames(var="index") %>%
  mutate(sum = rowSums(across(where(is.numeric)))) %>%
  mutate(across(Granulicella:uncultured.bacterium.40, ~ . / sum)) %>%
  select(-c('sum')) %>%
  mutate(Group1 = factor(Group1, levels = c('Duodenum','Jejunum','Ileum','Cecum'))) %>%
  select(-c('Group2'))
format_ITS_L6 <- raw_ITS_L6 %>%
  remove_rownames %>% 
  column_to_rownames(var="X") %>%
  mutate(sum = rowSums(across(where(is.numeric)))) %>%
  mutate(across(X__:unidentified.53, ~ . / sum)) %>%
  select(-c('sum')) %>%
  mutate(Group1 = factor(Group1, levels = c('Duodenum','Jejunum','Ileum','Cecum'))) %>%
  select(-c('Group2'))

format_16S_L6_AA <- format_16S_L6
format_ITS_L6_AA <- format_ITS_L6

for(i in 1:nrow(ab_temp)){
  format_16S_L6_AA[i,1:529] <- format_16S_L6[i,1:529] * 10^(ab_temp$`log10(16S)`[i])
  format_ITS_L6_AA[i,1:603] <- format_ITS_L6[i,1:603] * 10^(ab_temp$`log10(ITS)`[i])
}

vegdist_16S_AA <- vegdist(as.matrix(format_16S_L6_AA[,1:529]))
pcoa_16S_AA <- cmdscale(vegdist_16S_AA, eig = TRUE)
df_pcoa_16S_AA <- as.data.frame(pcoa_16S_AA$points)
colnames(df_pcoa_16S_AA) <- c('PCoA1', 'PCoA2')
PCo1_16S_AA <- round(eigenvals(pcoa_16S_AA)[1]/sum(eigenvals(pcoa_16S_AA)) * 100, 1)
PCo2_16S_AA <- round(eigenvals(pcoa_16S_AA)[2]/sum(eigenvals(pcoa_16S_AA)) * 100, 1)
print(PCo1_16S_AA)
print(PCo2_16S_AA)
df_pcoa_16S_AA$Cluster <- as.factor(clus_16S_ab$Cluster)
f14_9 <- ggplot(df_pcoa_16S_AA, aes(x = PCoA1, y = PCoA2, color = Cluster)) +
  geom_point() +
  theme_bw() +
  scale_color_manual(values = c('#E64B35','#4DBBD5','#00A087','#3C5488','#F39B7F')) +
  xlab('PCoA 1 (23.5%)') +
  ylab('PCoA 2 (16.7%)') +
  ggtitle('Bacteria') +
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA))

vegdist_ITS_AA <- vegdist(as.matrix(format_ITS_L6_AA[,1:603]))
pcoa_ITS_AA <- cmdscale(vegdist_ITS_AA, eig = TRUE)
df_pcoa_ITS_AA <- as.data.frame(pcoa_ITS_AA$points)
colnames(df_pcoa_ITS_AA) <- c('PCoA1', 'PCoA2')
PCo1_ITS_AA <- round(eigenvals(pcoa_ITS_AA)[1]/sum(eigenvals(pcoa_ITS_AA)) * 100, 1)
PCo2_ITS_AA <- round(eigenvals(pcoa_ITS_AA)[2]/sum(eigenvals(pcoa_ITS_AA)) * 100, 1)
print(PCo1_ITS_AA)
print(PCo2_ITS_AA)
df_pcoa_ITS_AA$Cluster <- as.factor(cluster_ITS$Cluster)
f14_10 <- ggplot(df_pcoa_ITS_AA, aes(x = PCoA1, y = PCoA2, color = Cluster)) +
  geom_point() +
  theme_bw() +
  scale_color_manual(values = c('#E64B35','#4DBBD5','#00A087','#3C5488')) +
  xlab('PCoA 1 (19.6%)') +
  ylab('PCoA 2 (14.2%)') +
  ggtitle('Fungi') +
  theme(panel.grid.major=element_line(colour=NA),panel.grid.minor = element_line(colour=NA))

f14_5 + f14_6 + f14_7 + f14_8 + f14_9 + f14_10 + plot_layout(nrow =3)
pairwise.adonis(format_16S_L6_AA[,1:529],clus_16S_ab$Cluster)
pairwise.adonis(format_ITS_L6_AA[,1:603],clus_ITS_ab$Cluster)
```

### Figure 3 D The relative importance of different ecological processes (heterogeneous selection: βNTI < -2, homogeneous selection: βNTI > 2, dispersal limitation: |βNTI| < 2 and RCBray > 0.95, homogenizing dispersal: |βNTI| < 2 and RCBray < -0.95, and undominated: |βNTI| < 2 and |RCBray| < 0.95) along the broiler gut microbiota.

#### Note: The calculation of RCbary and betaNTI was performed on server, which should be avoid to run on your own laptop or PC. Thus, we omit these scripts here. And we only show the presentation of the results. 

```{r}
# BetaNTI and RCbray
# Calculate the betaNTI and RCbray of 16S and ITS
# betaNTI: ape and iCAMP
# RCbray: vegan and script online
# Calculated on server (64 threads and 384 GB memory in total)
# betaNTI
# comp_16S_0 <- read.table('../Data/05NTI_RC/table-16S.tsv',header=T,row.names = 1,sep = '\t')
# cS_16S_1 <- colSums(comp_16S_0)
# comp_16S_1 <- comp_16S_0
# for(i in 1:320){
#   comp_16S_1[,i] <- comp_16S_0[,i]/cS_16S_1[i]
# }
# comp_16S_2 <- t(comp_16S_1)
# comp_16S_2_c <- comp_16S_2[seq(from = 1, to = 320,by = 4),]
# root_tree_16S <- read.tree('../Data/05NTI_RC/tree.nwk')
# nti_16S_C <- ses.comdistnt(comp_16S_2_c, cophenetic(root_tree_16S), abundance.weighted = T,cores = 20)
# write.table(nti_16S_C$comdistnt.obs.z,'../Data/05NTI_RC/NTI_16S_C.txt',quote = F)
# comp_16S_2_d <- comp_16S_2[seq(from = 2, to = 320,by = 4),]
# root_tree_16S <- read.tree('03rooted_tree/tree.nwk')
# nti_16S_D <- ses.comdistnt(comp_16S_2_d, cophenetic(root_tree_16S), abundance.weighted = T,cores = 20)
# write.table(nti_16S_D$comdistnt.obs.z,'../Data/05NTI_RC/NTI_16S_D.txt',quote = F)
# comp_16S_2_i <- comp_16S_2[seq(from = 3, to = 320,by = 4),]
# root_tree_16S <- read.tree('03rooted_tree/tree.nwk')
# nti_16S_I <- ses.comdistnt(comp_16S_2_i, cophenetic(root_tree_16S), abundance.weighted = T,cores = 20)
# write.table(nti_16S_I$comdistnt.obs.z,'../Data/05NTI_RC/NTI_16S_I.txt',quote = F)
# comp_16S_2_j <- comp_16S_2[seq(from = 4, to = 320,by = 4),]
# root_tree_16S <- read.tree('03rooted_tree/tree.nwk')
# nti_16S_J <- ses.comdistnt(comp_16S_2_j, cophenetic(root_tree_16S), abundance.weighted = T,cores = 20)
# write.table(nti_16S_J$comdistnt.obs.z,'../Data/05NTI_RC/NTI_16S_J.txt',quote = F)


# betaNTI ITS

# comp_ITS_0 <- read.table('../Data/05NTI_RC/table-ITS.tsv',header=T,row.names = 1,sep = '\t')
# cS_ITS_1 <- colSums(comp_ITS_0)
# comp_ITS_1 <- comp_ITS_0
# for(i in 1:320){
#   comp_ITS_1[,i] <- comp_ITS_0[,i]/cS_ITS_1[i]
# }
# comp_ITS_2 <- t(comp_ITS_1)
# comp_ITS_2_c <- comp_ITS_2[seq(from = 1, to = 320,by = 4),]
# root_tree_ITS <- read.tree('../Data/05NTI_RC/tree.nwk')
# nti_ITS_C <- ses.comdistnt(comp_ITS_2_c, cophenetic(root_tree_ITS), abundance.weighted = T,cores = 20)
# write.table(nti_ITS_C$comdistnt.obs.z,'../Data/05NTI_RC/NTI_ITS_C.txt',quote = F)
# 
# comp_ITS_2_d <- comp_ITS_2[seq(from = 2, to = 320,by = 4),]
# root_tree_ITS <- read.tree('03rooted_tree/tree.nwk')
# nti_ITS_D <- ses.comdistnt(comp_ITS_2_d, cophenetic(root_tree_ITS), abundance.weighted = T,cores = 20)
# write.table(nti_ITS_D$comdistnt.obs.z,'../Data/05NTI_RC/NTI_ITS_D.txt',quote = F)
# 
# comp_ITS_2_i <- comp_ITS_2[seq(from = 3, to = 320,by = 4),]
# root_tree_ITS <- read.tree('03rooted_tree/tree.nwk')
# nti_ITS_I <- ses.comdistnt(comp_ITS_2_i, cophenetic(root_tree_ITS), abundance.weighted = T,cores = 20)
# write.table(nti_ITS_I$comdistnt.obs.z,'../Data/05NTI_RC/NTI_ITS_I.txt',quote = F)
# 
# comp_ITS_2_j <- comp_ITS_2[seq(from = 4, to = 320,by = 4),]
# root_tree_ITS <- read.tree('03rooted_tree/tree.nwk')
# nti_ITS_J <- ses.comdistnt(comp_ITS_2_j, cophenetic(root_tree_ITS), abundance.weighted = T,cores = 20)
# write.table(nti_ITS_J$comdistnt.obs.z,'../Data/05NTI_RC/NTI_ITS_J.txt',quote = F)
# RCbray
# raup_crick=function(spXsite, plot_names_in_col1=FALSE, classic_metric=FALSE, split_ties=TRUE, reps=9999, set_all_species_equal=FALSE, as.distance.matrix=TRUE, report_similarity=FALSE){
#   if(plot_names_in_col1){
#     row.names(spXsite)<-spXsite[,1]
#     spXsite<-spXsite[,-1]
#   }
#   n_sites<-nrow(spXsite)
#   gamma<-ncol(spXsite)
#   ceiling(spXsite/max(spXsite))->spXsite
#   occur<-apply(spXsite, MARGIN=2, FUN=sum)
#   if(set_all_species_equal){
#     occur<-rep(1,gamma)
#   }
#   alpha_levels<-sort(unique(apply(spXsite, MARGIN=1, FUN=sum)))
#   alpha_table<-data.frame(c(NA), c(NA))
#   names(alpha_table)<-c("smaller_alpha", "bigger_alpha")
#   col_count<-1
#   null_array<-list()
#   for(a1 in 1:length(alpha_levels)){
#     for(a2 in a1:length(alpha_levels)){
#       ##build a null distribution of the number of shared species for a pair of alpha values:
#       null_shared_spp<-NULL
#       for(i in 1:reps){
#         ##two empty null communities of size gamma:
#         com1<-rep(0,gamma)
#         com2<-rep(0,gamma)
#         ##add alpha1 number of species to com1, weighting by species occurrence frequencies:
#         com1[sample(1:gamma, alpha_levels[a1], replace=FALSE, prob=occur)]<-1
#         ##same for com2:
#         com2[sample(1:gamma, alpha_levels[a2], replace=FALSE, prob=occur)]<-1
#         ##how many species are shared in common?
#         null_shared_spp[i]<-sum((com1+com2)>1)
#       }
#       null_array[[col_count]]<-null_shared_spp
#       alpha_table[col_count, which(names(alpha_table)=="smaller_alpha")]<-alpha_levels[a1]
#       alpha_table[col_count, which(names(alpha_table)=="bigger_alpha")]<-alpha_levels[a2]
#       col_count<-col_count+1
#     }
#   }
#   ##create a new column with both alpha levels to match on:
#   alpha_table$matching<-paste(alpha_table[,1], alpha_table[,2], sep="_")
#   results<-matrix(data=NA, nrow=n_sites, ncol=n_sites, dimnames=list(row.names(spXsite), row.names(spXsite)))
#   for(i in 1:n_sites){
#     for(j in 1:n_sites){
#       ##how many species are shared between the two sites:
#       n_shared_obs<-sum((spXsite[i,]+spXsite[j,])>1)
#       obs_a1<-sum(spXsite[i,])
#       obs_a2<-sum(spXsite[j,])
#       obs_a_pair<-sort(c(obs_a1, obs_a2))
#       null_index<-which(alpha_table$matching==paste(obs_a_pair[1], obs_a_pair[2], sep="_"))
#       num_exact_matching_in_null<-sum(null_array[[null_index]]==n_shared_obs)
#       num_greater_in_null<-sum(null_array[[null_index]]>n_shared_obs)
#       rc<-(num_greater_in_null)/reps
#       if(split_ties){
#         rc<-((num_greater_in_null+(num_exact_matching_in_null)/2)/reps)
#       }
#       if(!classic_metric){
#         ##our modification of raup crick standardizes the metric to range from -1 to 1 instead of 0 to 1
#         rc<-(rc-.5)*2
#       }
#       if(report_similarity & !classic_metric){
#         rc<- rc*-1
#       }
#       if(report_similarity & classic_metric){
#         rc<- 1-rc
#       }
#       results[i,j]<-round(rc, digits=2)
#     }
#   }
#   if(as.distance.matrix){
#     results<-as.dist(results)
#   } 
#   return(results)
# }
# RCbray 16S
# comp_16S_0 <- read.table('../Data/05NTI_RC/table-16S.tsv',header=T,row.names = 1, sep = '\t')
# dim(comp_16S_0)
# comp_16S_c <- comp_16S_0[,seq(from = 1, to = 320, by = 4)]
# comp_16S_d <- comp_16S_0[,seq(from = 2, to = 320, by = 4)]
# comp_16S_i <- comp_16S_0[,seq(from = 3, to = 320, by = 4)]
# comp_16S_j <- comp_16S_0[,seq(from = 4, to = 320, by = 4)]
# set.seed(1234)
# comp_16S_c2 <- phyloseq(otu_table(comp_16S_c, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_16S_c)))
# set.seed(1234)
# comp_16S_d2 <- phyloseq(otu_table(comp_16S_d, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_16S_d)))
# set.seed(1234)
# comp_16S_i2 <- phyloseq(otu_table(comp_16S_i, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_16S_i)))
# set.seed(1234)
# comp_16S_j2 <- phyloseq(otu_table(comp_16S_j, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_16S_j)))
# RC_16S_C <- raup_crick(t(comp_16S_c2@.Data))
# RC_16S_D <- raup_crick(t(comp_16S_d2@.Data))
# RC_16S_I <- raup_crick(t(comp_16S_i2@.Data))
# RC_16S_J <- raup_crick(t(comp_16S_j2@.Data))
# RC_16S_C2 <- as.matrix(RC_16S_C)
# RC_16S_D2 <- as.matrix(RC_16S_D)
# RC_16S_I2 <- as.matrix(RC_16S_I)
# RC_16S_J2 <- as.matrix(RC_16S_J)
# write.table(RC_16S_C2,'RCbray_16S_C.txt',quote=F)
# write.table(RC_16S_D2,'RCbray_16S_D.txt',quote=F)
# write.table(RC_16S_I2,'RCbray_16S_I.txt',quote=F)
# write.table(RC_16S_J2,'RCbray_16S_J.txt',quote=F)
# RCbray ITS
# comp_ITS_0 <- read.table('../Data/05NTI_RC/table-ITS.tsv',header=T,row.names = 1, sep = '\t')
# dim(comp_ITS_0)
# comp_ITS_c <- comp_ITS_0[,seq(from = 1, to = 320, by = 4)]
# comp_ITS_d <- comp_ITS_0[,seq(from = 2, to = 320, by = 4)]
# comp_ITS_i <- comp_ITS_0[,seq(from = 3, to = 320, by = 4)]
# comp_ITS_j <- comp_ITS_0[,seq(from = 4, to = 320, by = 4)]
# set.seed(1234)
# comp_ITS_c2 <- phyloseq(otu_table(comp_ITS_c, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_ITS_c)))
# set.seed(1234)
# comp_ITS_d2 <- phyloseq(otu_table(comp_ITS_d, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_ITS_d)))
# set.seed(1234)
# comp_ITS_i2 <- phyloseq(otu_table(comp_ITS_i, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_ITS_i)))
# set.seed(1234)
# comp_ITS_j2 <- phyloseq(otu_table(comp_ITS_j, taxa_are_rows = TRUE)) %>%
#   rarefy_even_depth(., min(colSums(comp_ITS_j)))
# RC_ITS_C <- raup_crick(t(comp_ITS_c2@.Data))
# RC_ITS_D <- raup_crick(t(comp_ITS_d2@.Data))
# RC_ITS_I <- raup_crick(t(comp_ITS_i2@.Data))
# RC_ITS_J <- raup_crick(t(comp_ITS_j2@.Data))
# RC_ITS_C2 <- as.matrix(RC_ITS_C)
# RC_ITS_D2 <- as.matrix(RC_ITS_D)
# RC_ITS_I2 <- as.matrix(RC_ITS_I)
# RC_ITS_J2 <- as.matrix(RC_ITS_J)
# write.table(RC_ITS_C2,'../Data/05NTI_RC/RCbray_ITS_C.txt',quote=F)
# write.table(RC_ITS_D2,'../Data/05NTI_RC/RCbray_ITS_D.txt',quote=F)
# write.table(RC_ITS_I2,'../Data/05NTI_RC/RCbray_ITS_I.txt',quote=F)
# write.table(RC_ITS_J2,'../Data/05NTI_RC/RCbray_ITS_J.txt',quote=F)

betaNTI_16S_C0 <- read.table('../Data/05NTI_RC/NTI_16S_C.txt', header = T, row.names = 1) 
betaNTI_16S_C0[upper.tri(betaNTI_16S_C0)] <- NA
betaNTI_16S_C <- betaNTI_16S_C0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()

betaNTI_16S_D0 <- read.table('../Data/05NTI_RC/NTI_16S_D.txt', header = T, row.names = 1)
betaNTI_16S_D0[upper.tri(betaNTI_16S_D0)] <- NA
betaNTI_16S_D <- betaNTI_16S_D0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()

betaNTI_16S_I0 <- read.table('../Data/05NTI_RC/NTI_16S_I.txt', header = T,row.names = 1)
betaNTI_16S_I0[upper.tri(betaNTI_16S_I0)] <- NA
betaNTI_16S_I <- betaNTI_16S_I0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()

betaNTI_16S_J0 <- read.table('../Data/05NTI_RC/NTI_16S_J.txt', header = T,row.names = 1)
betaNTI_16S_J0[upper.tri(betaNTI_16S_J0)] <- NA
betaNTI_16S_J <- betaNTI_16S_J0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()

betaNTI_ITS_C0 <- read.table('../Data/05NTI_RC/NTI_ITS_C.txt', header = T, row.names = 1) 
betaNTI_ITS_C0[upper.tri(betaNTI_ITS_C0)] <- NA
betaNTI_ITS_C <- betaNTI_ITS_C0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()

betaNTI_ITS_D0 <- read.table('../Data/05NTI_RC/NTI_ITS_D.txt', header = T, row.names = 1)
betaNTI_ITS_D0[upper.tri(betaNTI_ITS_D0)] <- NA
betaNTI_ITS_D <- betaNTI_ITS_D0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()

betaNTI_ITS_I0 <- read.table('../Data/05NTI_RC/NTI_ITS_I.txt', header = T,row.names = 1)
betaNTI_ITS_I0[upper.tri(betaNTI_ITS_I0)] <- NA
betaNTI_ITS_I <- betaNTI_ITS_I0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()

betaNTI_ITS_J0 <- read.table('../Data/05NTI_RC/NTI_ITS_J.txt', header = T,row.names = 1)
betaNTI_ITS_J0[upper.tri(betaNTI_ITS_J0)] <- NA
betaNTI_ITS_J <- betaNTI_ITS_J0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  mutate(values = -Value) %>%
  select(-c(Value)) %>%
  rename(NTI = values) %>%
  rename(R1 = rowname) %>%
  rename(ID1 = ID2) %>%
  drop_na()


RCbray_16S_C0 <- read.table('../Data/05NTI_RC/RCbray_16S_C.txt', header = T, row.names = 1) 
RCbray_16S_C0[upper.tri(RCbray_16S_C0)] <- NA
for(i in 1:80){
  RCbray_16S_C0[i,i] <- NA
}
RCbray_16S_C <- RCbray_16S_C0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()

RCbray_16S_D0 <- read.table('../Data/05NTI_RC/RCbray_16S_D.txt', header = T, row.names = 1)
RCbray_16S_D0[upper.tri(RCbray_16S_D0)] <- NA
for(i in 1:80){
  RCbray_16S_D0[i,i] <- NA
}
RCbray_16S_D <- RCbray_16S_D0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()

RCbray_16S_I0 <- read.table('../Data/05NTI_RC/RCbray_16S_I.txt', header = T,row.names = 1)
RCbray_16S_I0[upper.tri(RCbray_16S_I0)] <- NA
for(i in 1:80){
  RCbray_16S_I0[i,i] <- NA
}
RCbray_16S_I <- RCbray_16S_I0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()

RCbray_16S_J0 <- read.table('../Data/05NTI_RC/RCbray_16S_J.txt', header = T,row.names = 1)
RCbray_16S_J0[upper.tri(RCbray_16S_J0)] <- NA
for(i in 1:80){
  RCbray_16S_J0[i,i] <- NA
}
RCbray_16S_J <- RCbray_16S_J0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()

RCbray_ITS_C0 <- read.table('../Data/05NTI_RC/RCbray_ITS_C.txt', header = T, row.names = 1) 
RCbray_ITS_C0[upper.tri(RCbray_ITS_C0)] <- NA
for(i in 1:80){
  RCbray_ITS_C0[i,i] <- NA
}
RCbray_ITS_C <- RCbray_ITS_C0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()

RCbray_ITS_D0 <- read.table('../Data/05NTI_RC/RCbray_ITS_D.txt', header = T, row.names = 1)
RCbray_ITS_D0[upper.tri(RCbray_ITS_D0)] <- NA
for(i in 1:80){
  RCbray_ITS_D0[i,i] <- NA
}
RCbray_ITS_D <- RCbray_ITS_D0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()

RCbray_ITS_I0 <- read.table('../Data/05NTI_RC/RCbray_ITS_I.txt', header = T,row.names = 1)
RCbray_ITS_I0[upper.tri(RCbray_ITS_I0)] <- NA
for(i in 1:80){
  RCbray_ITS_I0[i,i] <- NA
}
RCbray_ITS_I <- RCbray_ITS_I0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()

RCbray_ITS_J0 <- read.table('../Data/05NTI_RC/RCbray_ITS_J.txt', header = T,row.names = 1)
RCbray_ITS_J0[upper.tri(RCbray_ITS_J0)] <- NA
for(i in 1:80){
  RCbray_ITS_J0[i,i] <- NA
}
RCbray_ITS_J <- RCbray_ITS_J0 %>%
  rownames_to_column() %>%
  gather(ID2, Value, -rowname) %>%
  rename(RC = Value) %>%
  rename(R2 = rowname) %>%
  drop_na()
NTI_RC_16S_C <- cbind(betaNTI_16S_C,RCbray_16S_C) %>%
  select(-c('R2','ID2'))
NTI_RC_16S_D <- cbind(betaNTI_16S_D,RCbray_16S_D) %>%
  select(-c('R2','ID2'))
NTI_RC_16S_I <- cbind(betaNTI_16S_I,RCbray_16S_I) %>%
  select(-c('R2','ID2'))
NTI_RC_16S_J <- cbind(betaNTI_16S_J,RCbray_16S_J) %>%
  select(-c('R2','ID2'))
NTI_RC_ITS_C <- cbind(betaNTI_ITS_C,RCbray_ITS_C) %>%
  select(-c('R2','ID2'))
NTI_RC_ITS_D <- cbind(betaNTI_ITS_D,RCbray_ITS_D) %>%
  select(-c('R2','ID2'))
NTI_RC_ITS_I <- cbind(betaNTI_ITS_I,RCbray_ITS_I) %>%
  select(-c('R2','ID2'))
NTI_RC_ITS_J <- cbind(betaNTI_ITS_J,RCbray_ITS_J) %>%
  select(-c('R2','ID2'))
for(i in 1:nrow(NTI_RC_16S_C)){
  if(NTI_RC_16S_C$NTI[i]>=2){
    NTI_RC_16S_C$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_16S_C$NTI[i]<= -2){
    NTI_RC_16S_C$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_16S_C$RC[i] >= 0.95){
    NTI_RC_16S_C$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_16S_C$RC[i] <= -0.95){
    NTI_RC_16S_C$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_16S_C$Cat[i] <- 'Undominated'}
}
for(i in 1:nrow(NTI_RC_16S_D)){
  if(NTI_RC_16S_D$NTI[i]>=2){
    NTI_RC_16S_D$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_16S_D$NTI[i]<= -2){
    NTI_RC_16S_D$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_16S_D$RC[i] >= 0.95){
    NTI_RC_16S_D$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_16S_D$RC[i] <= -0.95){
    NTI_RC_16S_D$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_16S_D$Cat[i] <- 'Undominated'}
}
for(i in 1:nrow(NTI_RC_16S_I)){
  if(NTI_RC_16S_I$NTI[i]>=2){
    NTI_RC_16S_I$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_16S_I$NTI[i]<= -2){
    NTI_RC_16S_I$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_16S_I$RC[i] >= 0.95){
    NTI_RC_16S_I$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_16S_I$RC[i] <= -0.95){
    NTI_RC_16S_I$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_16S_I$Cat[i] <- 'Undominated'}
}
for(i in 1:nrow(NTI_RC_16S_J)){
  if(NTI_RC_16S_J$NTI[i]>=2){
    NTI_RC_16S_J$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_16S_J$NTI[i]<= -2){
    NTI_RC_16S_J$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_16S_J$RC[i] >= 0.95){
    NTI_RC_16S_J$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_16S_J$RC[i] <= -0.95){
    NTI_RC_16S_J$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_16S_J$Cat[i] <- 'Undominated'}
}
for(i in 1:nrow(NTI_RC_ITS_C)){
  if(NTI_RC_ITS_C$NTI[i]>=2){
    NTI_RC_ITS_C$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_ITS_C$NTI[i]<= -2){
    NTI_RC_ITS_C$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_ITS_C$RC[i] >= 0.95){
    NTI_RC_ITS_C$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_ITS_C$RC[i] <= -0.95){
    NTI_RC_ITS_C$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_ITS_C$Cat[i] <- 'Undominated'}
}
for(i in 1:nrow(NTI_RC_ITS_D)){
  if(NTI_RC_ITS_D$NTI[i]>=2){
    NTI_RC_ITS_D$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_ITS_D$NTI[i]<= -2){
    NTI_RC_ITS_D$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_ITS_D$RC[i] >= 0.95){
    NTI_RC_ITS_D$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_ITS_D$RC[i] <= -0.95){
    NTI_RC_ITS_D$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_ITS_D$Cat[i] <- 'Undominated'}
}
for(i in 1:nrow(NTI_RC_ITS_I)){
  if(NTI_RC_ITS_I$NTI[i]>=2){
    NTI_RC_ITS_I$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_ITS_I$NTI[i]<= -2){
    NTI_RC_ITS_I$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_ITS_I$RC[i] >= 0.95){
    NTI_RC_ITS_I$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_ITS_I$RC[i] <= -0.95){
    NTI_RC_ITS_I$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_ITS_I$Cat[i] <- 'Undominated'}
}
for(i in 1:nrow(NTI_RC_ITS_J)){
  if(NTI_RC_ITS_J$NTI[i]>=2){
    NTI_RC_ITS_J$Cat[i] <- 'Homogeneous_selection'
  }
  else if(NTI_RC_ITS_J$NTI[i]<= -2){
    NTI_RC_ITS_J$Cat[i] <- 'Heterogenous_selection'
  }
  else if(NTI_RC_ITS_J$RC[i] >= 0.95){
    NTI_RC_ITS_J$Cat[i] <- 'Disperal_limitation'
  }
  else if(NTI_RC_ITS_J$RC[i] <= -0.95){
    NTI_RC_ITS_J$Cat[i] <- 'Homogenizing_disperal'
  }
  else{NTI_RC_ITS_J$Cat[i] <- 'Undominated'}
}

NTI_RC_16S_C1 <- NTI_RC_16S_C %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))
NTI_RC_16S_D1 <- NTI_RC_16S_D %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))
NTI_RC_16S_I1 <- NTI_RC_16S_I %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))
NTI_RC_16S_J1 <- NTI_RC_16S_J %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))

NTI_RC_16S_C2 <- table(NTI_RC_16S_C1[,c('Date','Category')]) %>%
  melt() %>%
  mutate(Segment = 'Cecum') %>%
  mutate(Ratio = value/45 * 100)

NTI_RC_16S_D2 <- table(NTI_RC_16S_D1[,c('Date','Category')]) %>%
  melt() %>%
  mutate(Segment = 'Duodenum') %>%
  mutate(Ratio = value/45 * 100)

NTI_RC_16S_I2 <- table(NTI_RC_16S_I1[,c('Date','Category')]) %>%
  melt() %>%
  mutate(Segment = 'Ileum') %>%
  mutate(Ratio = value/45 * 100)
NTI_RC_16S_J2 <- table(NTI_RC_16S_J1[,c('Date','Category')]) %>%
  melt()%>%
  mutate(Segment = 'Jejunum') %>%
  mutate(Ratio = value/45 * 100)

NTI_RC_16S <- rbind(NTI_RC_16S_D2, NTI_RC_16S_J2, NTI_RC_16S_I2, NTI_RC_16S_C2)
NTI_RC_16S$Segment <- factor(NTI_RC_16S$Segment, levels = c('Duodenum','Jejunum','Ileum','Cecum'))
NTI_RC_16S$Category <- factor(NTI_RC_16S$Category, levels = rev(c('Undominated','Homogeneous selection','Heterogenous selection',
                                                                  'Disperal limitation','Homogenizing disperal')))
NTI_RC_bar1 <- ggplot(NTI_RC_16S, aes(x = Date, y = Ratio, fill = Category)) +
  geom_bar(stat = 'identity',position = 'stack') +
  facet_grid(.~Segment) +
  xlab('DPH') +
  scale_fill_manual(values = rev(c('#E64B35','#4DBBD5','#3C5488','#F39B7F'))) +
  theme_bw() +
  ylab("Ratio (%)") +
  scale_x_discrete(label = c(1,4,7,14,21,28,35,42)) +
  theme(axis.text.x = element_text(angle = 90,hjust = 1)) +
  ggtitle('Bacteria')
NTI_RC_ITS_C1 <- NTI_RC_ITS_C %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))
NTI_RC_ITS_D1 <- NTI_RC_ITS_D %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))
NTI_RC_ITS_I1 <- NTI_RC_ITS_I %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))
NTI_RC_ITS_J1 <- NTI_RC_ITS_J %>%
  mutate(ID = paste0(substr(R1,1,3),substr(ID1,1,3))) %>%
  filter(ID %in% c('D01D01','D04D04','D07D07','D14D14','D21D21','D28D28','D35D35','D42D42')) %>%
  mutate(Category = gsub("_", " ", Cat)) %>%
  mutate(ID_mask = paste0('ID',1:360)) %>%
  mutate(Date = substr(ID,1,3)) %>%
  select(c(Date,ID_mask,Category,NTI,RC))

NTI_RC_ITS_C2 <- table(NTI_RC_ITS_C1[,c('Date','Category')]) %>%
  melt() %>%
  mutate(Segment = 'Cecum') %>%
  mutate(Ratio = value/45 * 100)

NTI_RC_ITS_D2 <- table(NTI_RC_ITS_D1[,c('Date','Category')]) %>%
  melt() %>%
  mutate(Segment = 'Duodenum') %>%
  mutate(Ratio = value/45 * 100)

NTI_RC_ITS_I2 <- table(NTI_RC_ITS_I1[,c('Date','Category')]) %>%
  melt() %>%
  mutate(Segment = 'Ileum') %>%
  mutate(Ratio = value/45 * 100)
NTI_RC_ITS_J2 <- table(NTI_RC_ITS_J1[,c('Date','Category')]) %>%
  melt()%>%
  mutate(Segment = 'Jejunum') %>%
  mutate(Ratio = value/45 * 100)

NTI_RC_ITS <- rbind(NTI_RC_ITS_D2, NTI_RC_ITS_J2, NTI_RC_ITS_I2, NTI_RC_ITS_C2)
NTI_RC_ITS$Segment <- factor(NTI_RC_ITS$Segment, levels = c('Duodenum','Jejunum','Ileum','Cecum'))
NTI_RC_ITS$Category <- factor(NTI_RC_ITS$Category, levels = rev(c('Undominated','Homogeneous selection','Heterogenous selection',
                                                                  'Disperal limitation','Homogenizing disperal')))
NTI_RC_bar2 <- ggplot(NTI_RC_ITS, aes(x = Date, y = Ratio, fill = Category)) +
  geom_bar(stat = 'identity',position = 'stack') +
  facet_grid(.~Segment) +
  xlab('DPH') +
  scale_fill_manual(values = rev(c('#E64B35','#4DBBD5','#00A087','#3C5488','#F39B7F'))) +
  theme_bw() +
  ylab("Ratio (%)") +
  scale_x_discrete(label = c(1,4,7,14,21,28,35,42)) +
  theme(axis.text.x = element_text(angle = 90,hjust = 1)) +
  ggtitle('Fungi')

NTI_RC_16S_RA <- NTI_RC_16S %>%
  filter(Category %in% 'Undominated') %>%
  group_by(Segment)%>%
  summarise_at(vars(Ratio), funs(mean(., na.rm=TRUE))) %>%
  data.frame() %>%
  mutate(Sequence = '16S')
NTI_RC_ITS_RA <- NTI_RC_ITS %>%
  filter(Category %in% 'Undominated') %>%
  group_by(Segment)%>%
  summarise_at(vars(Ratio), funs(mean(., na.rm=TRUE))) %>%
  data.frame() %>%
  mutate(Sequence = 'ITS')
rbind(NTI_RC_16S_RA, NTI_RC_ITS_RA) %>%
  ggplot(aes(x = Segment, y = Ratio, fill = Sequence)) +
  geom_bar(stat = 'identity',position = 'dodge')+
  scale_fill_manual(values = c('#426E9D','#DD4D4F')) +
  theme_bw() +
  theme(legend.position = c(0.2,0.2)) +
  ylab('Ratio (%)')
NTI_RC_bar1 <- ggplot(NTI_RC_16S, aes(x = Date, y = Ratio, fill = Category)) +
  geom_bar(stat = 'identity',position = 'stack') +
  facet_grid(.~Segment) +
  xlab('DPH') +
  scale_fill_manual(values = rev(c('#E64B35','#4DBBD5','#3C5488','#F39B7F'))) +
  theme_bw() +
  ylab("Ratio (%)") +
  scale_x_discrete(label = c(1,4,7,14,21,28,35,42)) +
  theme(axis.text.x = element_text(angle = 90,hjust = 1)) +
  ggtitle('Bacteria')
NTI_RC_bar2 <- ggplot(NTI_RC_ITS, aes(x = Date, y = Ratio, fill = Category)) +
  geom_bar(stat = 'identity',position = 'stack') +
  facet_grid(.~Segment) +
  xlab('DPH') +
  scale_fill_manual(values = rev(c('#E64B35','#4DBBD5','#00A087','#3C5488','#F39B7F'))) +
  theme_bw() +
  ylab("Ratio (%)") +
  scale_x_discrete(label = c(1,4,7,14,21,28,35,42)) +
  theme(axis.text.x = element_text(angle = 90,hjust = 1)) +
  ggtitle('Fungi')

NTI_RC_bar1 + NTI_RC_bar2 + plot_layout(guides = 'collect')

```

